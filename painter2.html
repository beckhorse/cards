<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Painter - Beckhorse Special Edition</title>
    <style>
        body { 
            margin: 0; 
            background: #ffffff; 
            font-family: "Microsoft JhengHei", sans-serif; 
            overflow: hidden; 
            touch-action: none; 
        }

        /* ç•«å¸ƒæ¨£å¼ */
        #canvas { 
            width: 100vw; 
            height: 100vh; 
            display: block; 
            cursor: crosshair;
        }

        /* ç‹€æ…‹æç¤ºï¼ˆè¡¨æ¼”æ™‚å¯è¨­ç‚º color: transparent éš±è—ï¼‰ */
        #status { 
            position: fixed; 
            top: 20px; 
            width: 100%; 
            text-align: center; 
            color: #eeeeee; 
            font-size: 14px; 
            pointer-events: none; 
            z-index: 10;
        }

        /* é è¨€çµæœå®¹å™¨ */
        .prediction-container {
            position: fixed; 
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 80%;
            pointer-events: none;
        }

        .prediction {
            display: none;
            opacity: 0;
            font-size: 80px;
        }

        /* æ‰‹å¯«æ„Ÿå‹•ç•«ï¼šå¾æ¨¡ç³Šåˆ°æ¸…æ™° */
        .show-result {
            display: block;
            animation: handDrawEffect 1.5s forwards;
        }

        @keyframes handDrawEffect {
            0% { opacity: 0; filter: blur(20px); transform: scale(0.8); }
            100% { opacity: 1; filter: blur(0); transform: scale(1); }
        }

        /* éš±è—çš„æˆæ¬ŠæŒ‰éˆ•ï¼ˆiOS å¿…å‚™ï¼‰ */
        #auth-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border: none;
            border-radius: 5px;
            font-size: 10px;
            color: #ccc;
        }
    </style>
</head>
<body>

    <div id="status">æ­£åœ¨æº–å‚™ç•«ç´™... (é»æ“Šå³ä¸‹è§’æˆæ¬Š)</div>
    
    <canvas id="canvas"></canvas>

    <div class="prediction-container">
        <div id="res-A" class="prediction">ğŸ</div> <div id="res-B" class="prediction">ğŸŒ</div> <div id="res-C" class="prediction">ğŸ‡</div> <div id="res-D" class="prediction"> watermelon </div> </div>

    <button id="auth-btn" onclick="initSensors()">å•Ÿå‹•æ„Ÿæ‡‰å™¨</button>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let isFaceDown = false;
        let predictionTriggered = false;

        // 1. åˆå§‹åŒ–ç•«å¸ƒ
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.strokeStyle = "#333333";
            ctx.lineWidth = 4;
            ctx.lineJoin = "round";
            ctx.lineCap = "round";
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 2. æ»‘é †ç•«ç­†é‚è¼¯
        canvas.addEventListener('pointerdown', (e) => {
            if (predictionTriggered) return;
            isDrawing = true;
            [lastX, lastY] = [e.clientX, e.clientY];
        });

        canvas.addEventListener('pointermove', (e) => {
            if (!isDrawing || predictionTriggered) return;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.clientX, e.clientY);
            ctx.stroke();
            
            [lastX, lastY] = [e.clientX, e.clientY];
        });

        canvas.addEventListener('pointerup', () => isDrawing = false);

        // 3. é›™æ“Šæ¸…ç©ºç•«å¸ƒ (éš±è—åŠŸèƒ½ï¼Œæ–¹ä¾¿é‡è¤‡è¡¨æ¼”)
        canvas.addEventListener('dblclick', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            predictionTriggered = false;
            document.querySelectorAll('.prediction').forEach(el => el.classList.remove('show-result'));
            status.innerText = "ç•«ç´™å·²æ›´æ›";
        });

        // 4. é™€èºå„€åµæ¸¬èˆ‡æ¬Šé™
        function initSensors() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            document.getElementById('auth-btn').style.display = 'none';
                            status.innerText = "ç³»çµ±å°±ç·’";
                        }
                    })
                    .catch(console.error);
            } else {
                // é iOS è£ç½®ç›´æ¥ç›£è½
                window.addEventListener('deviceorientation', handleOrientation);
                document.getElementById('auth-btn').style.display = 'none';
                status.innerText = "ç³»çµ±å°±ç·’";
            }
        }

        function handleOrientation(event) {
            if (predictionTriggered) return;

            let beta = event.beta;   // å‰å¾Œç¿»è½‰ (-180 åˆ° 180)
            let gamma = event.gamma; // å·¦å³ç¿»è½‰ (-90 åˆ° 90)

            // A. åµæ¸¬æ˜¯å¦è¢å¹•æœä¸‹æ”¾ç½® (é­”è¡“é–‹å§‹)
            if (Math.abs(beta) > 150) {
                isFaceDown = true;
                status.innerText = "é è¨€å·²é–å®š...";
            }

            // B. ç•¶æ‰‹æ©Ÿå¾æœä¸‹ç¿»è½‰å›æœä¸Š (åµæ¸¬è·¯å¾‘)
            if (isFaceDown && Math.abs(beta) < 40) {
                predictionTriggered = true;
                isFaceDown = false;

                // é‚è¼¯åˆ¤å®š
                if (gamma > 35) {
                    showResult('res-A'); // ç”±å·¦å‘å³ç¿»
                } else if (gamma < -35) {
                    showResult('res-B'); // ç”±å³å‘å·¦ç¿»
                } else if (beta < -15) {
                    showResult('res-C'); // ç”±ä¸‹å‘ä¸Šç¿»
                } else {
                    showResult('res-D'); // ç”±ä¸Šå‘ä¸‹ç¿»
                }
            }
        }

        function showResult(id) {
            // å…ˆæ·¡å‡ºç•«å¸ƒä¸Šçš„ç­†è·¡
            ctx.globalAlpha = 0.2;
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 1.0;

            const target = document.getElementById(id);
            target.classList.add('show-result');
            status.innerText = "";
        }
    </script>
</body>
</html>