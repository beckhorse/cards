<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Note Stealth</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; }
        #setup-screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: #1a1a1a; color: white; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 10px; border: none; background: #444; color: white; }

        #black-screen { position: fixed; inset: 0; background: #000; z-index: 50; display: none; }

        #draw-screen { position: fixed; inset: 0; background: #fff; z-index: 10; display: block; }
        canvas { width: 100%; height: 100%; touch-action: none; }
        
        /* 核心優化：針對無補光環境的濾鏡 */
        #peek-video { 
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            width: 140px; 
            height: auto; 
            opacity: 0.25; 
            z-index: 60;
            transform: scaleX(-1); 
            /* 強化濾鏡：在無光環境下盡量突顯白色牌面與黑色/紅色花色的對比 */
            filter: brightness(1.6) contrast(200%) grayscale(0.2);
            pointer-events: none;
            border-radius: 4px;
        }
        
        #debug-info { position: fixed; top: 10px; left: 10px; font-size: 10px; color: #eee; z-index: 70; pointer-events: none; mix-blend-mode: difference; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h3>Magic System Ready</h3>
        <button onclick="initMagic()">Initialize System</button>
    </div>

    <div id="black-screen" onclick="forceStop()"></div>

    <div id="draw-screen">
        <div id="debug-info">READY</div>
        <video id="peek-video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <script>
        let mediaRecorder;
        let chunks = [];
        let isRecording = false;
        const peekVideo = document.getElementById('peek-video');
        const blackScreen = document.getElementById('black-screen');
        const debugInfo = document.getElementById('debug-info');
        let stream;

        async function initMagic() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }, 
                    audio: false 
                });
                peekVideo.srcObject = stream;
                
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }

                window.addEventListener('deviceorientation', handleMotion);
                document.getElementById('setup-screen').style.display = 'none';
                initCanvas();
            } catch (err) {
                alert("啟動失敗: " + err.message);
            }
        }

        function handleMotion(event) {
            let beta = event.beta; 
            // 螢幕朝下判斷
            if (Math.abs(beta) > 165) {
                if (!isRecording) startRecording();
            } else if (Math.abs(beta) < 45) {
                // 拿起手機判斷
                if (isRecording) stopRecording();
            }
        }

        function startRecording() {
            if (isRecording) return;
            isRecording = true;
            chunks = [];
            
            peekVideo.srcObject = stream;
            peekVideo.play();

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                peekVideo.srcObject = null;
                peekVideo.src = URL.createObjectURL(blob);
                peekVideo.loop = true;
                peekVideo.play();
            };
            
            mediaRecorder.start();
            blackScreen.style.display = 'block';
            debugInfo.innerText = "CAPTURING";
        }

        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
            blackScreen.style.display = 'none';
            debugInfo.innerText = "ANALYZING";
        }

        function forceStop() { stopRecording(); }

        function initCanvas() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            let drawing = false;
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#333';

            const getPos = (e) => ({
                x: (e.touches ? e.touches[0].clientX : e.clientX),
                y: (e.touches ? e.touches[0].clientY : e.clientY)
            });

            canvas.addEventListener('touchstart', (e) => { 
                drawing = true; 
                ctx.beginPath(); 
                ctx.moveTo(getPos(e).x, getPos(e).y); 
            });
            canvas.addEventListener('touchmove', (e) => { 
                if(!drawing) return; 
                ctx.lineTo(getPos(e).x, getPos(e).y); 
                ctx.stroke(); 
            });
            canvas.addEventListener('touchend', () => drawing = false);
        }
    </script>
</body>
</html>