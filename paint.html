<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sketchboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #f0f0f0; display: flex; flex-direction: column; height: 100vh; }
        #canvasContainer { flex-grow: 1; position: relative; background: white; }
        canvas { display: block; touch-action: none; }
        /* 隱藏所有狀態文字，僅供魔術師觀察的極小提示 */
        #magicStatus { 
            position: absolute; bottom: 5px; right: 5px; 
            font-size: 8px; color: rgba(0,0,0,0.05); /* 幾乎看不見 */
            pointer-events: none;
        }
        #controls { 
            background: #e0e0e0; padding: 15px; display: flex; 
            justify-content: space-around; align-items: center; 
            border-top: 1px solid #ccc;
        }
        .tool { width: 35px; height: 35px; border-radius: 5px; border: 1px solid #999; cursor: pointer; }
        .active { border: 2px solid #000; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        
        /* 手寫數字樣式 */
        #predictedNumber { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 40vw; font-family: 'Caveat', cursive; color: #000; 
            opacity: 0; transition: opacity 1.5s ease-in; z-index: 100;
            pointer-events: none; white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="canvasContainer">
        <canvas id="drawingCanvas"></canvas>
        <div id="predictedNumber"></div>
        <div id="magicStatus">.</div>
    </div>
    <div id="controls">
        <div class="tool" style="background: black;" onclick="setTool('black', this)"></div>
        <div class="tool" style="background: red;" onclick="setTool('red', this)"></div>
        <div class="tool" style="background: blue;" onclick="setTool('blue', this)"></div>
        <div id="eraser" class="tool" style="background: #eee; display: flex; justify-content: center; align-items: center; font-size: 12px;" onclick="setTool('eraser', this)">消</div>
    </div>

    <script>
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const numDiv = document.getElementById('predictedNumber');
        const magicStatus = document.getElementById('magicStatus');
        
        let painting = false;
        let tool = 'black';
        let hasStarted = false;
        let predictedNumber = "";
        let isFaceDown = false;
        let hasSpoken = false;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - document.getElementById('controls').offsetHeight;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        window.addEventListener('resize', resize);
        resize();

        function setTool(t, el) {
            tool = t;
            document.querySelectorAll('.tool').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            
            // 第一次點擊畫筆時，靜悄悄啟動語音權限請求
            if (!hasStarted) {
                startVoiceEngine();
                hasStarted = true;
            }
        }

        // 繪圖邏輯
        function start(e) { 
            painting = true; 
            draw(e); 
            if (!hasStarted) { startVoiceEngine(); hasStarted = true; }
        }
        function end() { painting = false; ctx.beginPath(); }
        function draw(e) {
            if (!painting) return;
            const t = e.touches ? e.touches[0] : e;
            ctx.lineWidth = tool === 'eraser' ? 30 : 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = tool === 'eraser' ? 'white' : tool;
            ctx.lineTo(t.clientX, t.clientY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(t.clientX, t.clientY);
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('touchstart', start);
        canvas.addEventListener('mouseup', end);
        canvas.addEventListener('touchend', end);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', draw);

        // 語音引擎 (靜默模式)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.lang = 'zh-TW';
            recognition.interimResults = true;
            recognition.continuous = true;
            recognition.onresult = (e) => {
                let text = Array.from(e.results).map(r => r[0].transcript).join('');
                let match = text.match(/\d+/);
                if (match) {
                    predictedNumber = match[0];
                    hasSpoken = true;
                    magicStatus.innerText = "v"; // 極小提示：已收到數字
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            };
            recognition.onend = () => { if (isFaceDown && !hasSpoken) recognition.start(); };
        }

        function startVoiceEngine() {
            try { recognition.start(); } catch(e) {}
        }

        // 翻轉偵測
        window.addEventListener('deviceorientation', (e) => {
            if (Math.abs(e.beta) > 160) { // 螢幕朝下
                if (!isFaceDown) {
                    isFaceDown = true;
                    // 螢幕朝下時，悄悄清空畫布
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } else if (Math.abs(e.beta) < 40) { // 螢幕朝上
                if (isFaceDown) {
                    isFaceDown = false;
                    if (hasSpoken) {
                        numDiv.innerText = predictedNumber;
                        numDiv.style.opacity = "1";
                    }
                }
            }
        });

        document.querySelectorAll('.tool')[0].classList.add('active');
    </script>
</body>
</html>