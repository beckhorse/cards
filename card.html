<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Voice Magic Pro - Magic is Life</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: sans-serif; }
        #status { position: absolute; top: 20px; width: 100%; text-align: center; color: #00ff00; font-size: 16px; z-index: 1000; padding: 0 20px; box-sizing: border-box; }
        #debug { position: absolute; bottom: 10px; width: 100%; text-align: center; color: rgba(255,255,255,0.2); font-size: 10px; }
        .card { 
            position: absolute; width: 60px; height: 85px; background: white; border-radius: 5px; 
            display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.7); transition: transform 0.1s linear, opacity 0.5s ease;
        }
        .red { color: red; }
        .black { color: black; }
        #flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 2000; }
    </style>
</head>
<body>
    <div id="status">【點擊螢幕啟動 AI 辨識】</div>
    <div id="debug">等待語音輸入...</div>
    <div id="flash"></div>
    <div id="stage"></div>

    <script>
        const stage = document.getElementById('stage');
        const status = document.getElementById('status');
        const debug = document.getElementById('debug');
        const flash = document.getElementById('flash');
        let cards = [];
        let targetCardName = "";
        let isDropped = false;

        function initCards() {
            const suits = ['♠', '♥', '♦', '♣'];
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            suits.forEach(s => {
                ranks.forEach(r => {
                    const el = document.createElement('div');
                    el.className = `card ${ (s==='♥' || s==='♦') ? 'red' : 'black' }`;
                    el.innerText = s + r;
                    const cObj = {
                        el, name: s + r,
                        // 擴充比對詞庫，增加魔術表演靈活度
                        keywords: [
                            s+r, 
                            (s==='♥'?'紅心':s==='♦'?'方塊':s==='♠'?'黑桃':'梅花')+r,
                            (s==='♥'?'愛心':s==='♦'?'鑽石':s==='♠'?'黑桃':'梅花')+r,
                            r==='A'?'Ace':r
                        ],
                        x: Math.random() * (window.innerWidth - 60),
                        y: Math.random() * (window.innerHeight - 85),
                        vx: (Math.random() - 0.5) * 1.5, vy: (Math.random() - 0.5) * 1.5,
                        rot: Math.random() * 360, isActive: true
                    };
                    stage.appendChild(el);
                    cards.push(cObj);
                });
            });
        }

        // 語音辨識核心
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.interimResults = true; // 即時回傳，不用等講完
            recognition.continuous = true;

            recognition.onresult = (event) => {
                let current = "";
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    current += event.results[i][0].transcript;
                }
                debug.innerText = "聽取中: " + current;

                // 即時比對
                cards.forEach(c => {
                    if (!targetCardName) {
                        c.keywords.forEach(key => {
                            if (current.toUpperCase().includes(key.toUpperCase())) {
                                lockTarget(c.name);
                            }
                        });
                    }
                });
            };

            recognition.onend = () => {
                // 自動重啟，防止辨識中斷
                if (!isDropped) recognition.start();
            };

            recognition.onerror = (e) => {
                console.error(e);
                if (e.error === 'not-allowed') status.innerText = "請允許麥克風權限！";
            };
        }

        function lockTarget(name) {
            targetCardName = name;
            status.innerText = "AI 鎖定目標：" + targetCardName;
            status.style.color = "#00ffff";
            status.style.fontSize = "20px";
            // 震動回饋 (Android 特色)
            if (navigator.vibrate) navigator.vibrate(50);
        }

        window.onclick = () => {
            if (isDropped) return;
            if (targetCardName) {
                triggerDrop(); // 已經有目標時，點擊直接觸發
            } else {
                try {
                    recognition.start();
                    status.innerText = "【AI 正在聆聽，請說出一張牌】";
                } catch(e) {}
            }
        };

        // 搖晃偵測
        let lastAcc = {x: 0, y: 0, z: 0};
        window.addEventListener('devicemotion', (e) => {
            if (!e.accelerationIncludingGravity || isDropped || !targetCardName) return;
            let acc = e.accelerationIncludingGravity;
            let change = Math.abs(acc.x - lastAcc.x) + Math.abs(acc.y - lastAcc.y);
            if (change > 20) triggerDrop();
            lastAcc = {x: acc.x, y: acc.y, z: acc.z};
        });

        function triggerDrop() {
            if (isDropped) return;
            isDropped = true;
            flash.style.opacity = "0.8";
            setTimeout(() => flash.style.opacity = "0", 300);
            status.innerText = "數據重組完成";
            
            cards.forEach(c => {
                if (c.name !== targetCardName) {
                    c.vy = 25;
                    c.isActive = false;
                    setTimeout(() => c.el.style.opacity = "0", 500);
                } else {
                    c.vx = 0; c.vy = 0;
                    c.x = window.innerWidth / 2 - 30;
                    c.y = window.innerHeight / 2 - 42;
                    c.el.style.transform = "scale(3) rotate(0deg)";
                    c.el.style.zIndex = "5000";
                    c.el.style.boxShadow = "0 0 30px #00ffff";
                }
            });
        }

        function update() {
            cards.forEach(c => {
                if (!isDropped) {
                    c.x += c.vx; c.y += c.vy;
                    if (c.x < 0 || c.x > window.innerWidth - 60) c.vx *= -1;
                    if (c.y < 0 || c.y > window.innerHeight - 85) c.vy *= -1;
                } else if (!c.isActive) {
                    c.y += c.vy;
                }
                c.el.style.left = c.x + 'px';
                c.el.style.top = c.y + 'px';
                if (!isDropped) c.el.style.transform = `rotate(${c.rot}deg)`;
            });
            requestAnimationFrame(update);
        }

        initCards();
        update();
    </script>
</body>
</html>