<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sketch Pad">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link rel="manifest" href="manifest.json">

    <script>
      // ä¿®æ­£ï¼šç¢ºä¿ Service Worker è¨»å†Šä¸æœƒå¹²æ“¾é¦–é é‚è¼¯
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').catch(e => console.log(e));
        });
      }
    </script>
    
    <title>Sketch Pad Pro</title>
    <style>
        body{margin:0;background:#fff;overflow:hidden;touch-action:none;font-family:sans-serif;width:100vw;height:100vh}
        #canvas{width:100vw;height:100vh;display:block;position:relative;z-index:5}
        .toolbar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:10px;background:rgba(255,255,255,.95);padding:12px 18px;border-radius:50px;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:100;align-items:center}
        .color-btn{width:24px;height:24px;border-radius:50%;border:1px solid #ddd;cursor:pointer}
        .divider{width:1px;height:24px;background:#ddd;margin:0 5px}
        .icon-btn{background:none;border:none;font-size:20px;cursor:pointer;padding:5px}
        #prediction-layer{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:1;width:80vw;display:flex;justify-content:center;align-items:center}
        .prediction{display:none;max-width:100%;max-height:60vh;object-fit:contain}
        .show-now{display:block!important}
        
        /* æ ¸å¿ƒä¿®æ­£ï¼šè®“é®ç½©ç¨å¾®æœ‰ä¸€é»é»èƒŒæ™¯è‰²(0.01)ï¼Œç¢ºä¿ iOS èªå¾—é€™æ¬¡é»æ“Š */
        #init-overlay{
            position:fixed;top:0;left:0;width:100%;height:100%;
            z-index:9999;background:rgba(255,255,255,0.01);
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="init-overlay"></div>
    <canvas id="canvas"></canvas>

    <div class="toolbar">
        <div class="color-btn" style="background:#000000" onclick="_0x4a2b('#000000',3)"></div>
        <div class="color-btn" style="background:#be0000" onclick="_0x4a2b('#be0000',3)"></div>
        <div class="color-btn" style="background:#2ed573" onclick="_0x4a2b('#2ed573',3)"></div>
        <div class="color-btn" style="background:#1e90ff" onclick="_0x4a2b('#1e90ff',3)"></div>
        <div class="color-btn" style="background:#ffa502" onclick="_0x4a2b('#ffa502',3)"></div>
        <div class="divider"></div>
        <button class="icon-btn" onclick="_0x4a2b('#ffffff',30)">ğŸ§¼</button>
        <button class="icon-btn" onclick="_0x1f3c()">ğŸ—‘ï¸</button>
    </div>

    <div id="prediction-layer">
        <img id="res-A" class="prediction" src="h3.png">
        <img id="res-B" class="prediction" src="d9.png">
        <img id="res-C" class="prediction" src="c6.png">
        <img id="res-D" class="prediction" src="s12.png">
    </div>

    <script>
        (function(){
            const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d'), overlay = document.getElementById('init-overlay');
            let drawing = false, lastX = 0, lastY = 0, shakeTriggered = false, shown = false, permissionGranted = false;

            // ä¿®æ­£ï¼šä½¿ç”¨ getBoundingClientRect è§£æ±º iPhone åº§æ¨™ä½ç§»
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                return {
                    x: (clientX - rect.left) * (canvas.width / rect.width),
                    y: (clientY - rect.top) * (canvas.height / rect.height)
                };
            }

            window._0x4a2b = (c, w) => { ctx.strokeStyle = c; ctx.lineWidth = w; };
            window._0x1f3c = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                document.querySelectorAll('.prediction').forEach(i => i.classList.remove('show-now'));
                shown = false; shakeTriggered = false;
            };

            // æ ¸å¿ƒä¿®æ­£ï¼šé‡å° iOS Standalone æ¨¡å¼çš„æ¬Šé™è«‹æ±‚
            async function requestMotionPermission() {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const response = await DeviceOrientationEvent.requestPermission();
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleMotion, true);
                            permissionGranted = true;
                        }
                    } catch (e) { alert("è«‹ç¢ºä¿ä½¿ç”¨ HTTPS ä¸¦åœ¨æç¤ºæ™‚é»æ“Šå…è¨±ã€‚"); }
                } else {
                    window.addEventListener('deviceorientation', handleMotion, true);
                    permissionGranted = true;
                }
            }

            function handleMotion(e) {
                if (shown) return;
                let b = e.beta, g = e.gamma;
                if (Math.abs(b) > 155) shakeTriggered = true;
                if (shakeTriggered && Math.abs(b) < 60) {
                    shown = true; shakeTriggered = false;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let id = (g > 30) ? 'res-A' : (g < -30) ? 'res-B' : (b < -10) ? 'res-C' : 'res-D';
                    document.getElementById(id).classList.add('show-now');
                }
            }

            function init() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.lineJoin = 'round'; ctx.lineCap = 'round';
                _0x4a2b('#000000', 3);
            }

            // é—œéµæ”¹å‹•ï¼šiOS å¿…é ˆåµæ¸¬åˆ°æ˜ç¢ºçš„ click äº‹ä»¶
            overlay.addEventListener('click', async (e) => {
                await requestMotionPermission();
                overlay.style.display = 'none';
                console.log("Permission requested via click");
            });

            // ç¹ªåœ–é‚è¼¯ (æ”¯æ´ Touch èˆ‡ Pointer)
            const startDraw = (e) => {
                drawing = true;
                const p = getPos(e);
                [lastX, lastY] = [p.x, p.y];
            };
            const moveDraw = (e) => {
                if (!drawing) return;
                const p = getPos(e);
                ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.stroke();
                [lastX, lastY] = [p.x, p.y];
            };

            canvas.addEventListener('touchstart', startDraw, {passive: false});
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveDraw(e); }, {passive: false});
            canvas.addEventListener('touchend', () => drawing = false);

            window.addEventListener('resize', init);
            init();
        })();
    </script>
</body>
</html>
