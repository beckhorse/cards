<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sketch Pad">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
        });
      }
    </script>
    
    <title>Sketch Pad Pro</title>
    <style>
        /* ä¿®æ­£ PWA åœ¨ iPhone 11 ä¸Šçš„å…¨è¢å¹•ä½ˆå±€ */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #fff; touch-action: none;
        }
        #canvas { 
            display: block; width: 100vw; height: 100vh; 
            position: absolute; top: 0; left: 0; z-index: 5;
        }
        .toolbar { 
            position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 50%; transform: translateX(-50%); 
            display: flex; gap: 10px; background: rgba(255,255,255,.95); 
            padding: 12px 18px; border-radius: 50px; 
            box-shadow: 0 4px 20px rgba(0,0,0,.15); z-index: 100; align-items: center;
        }
        .color-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #ddd; cursor: pointer; }
        .divider { width: 1px; height: 24px; background: #ddd; margin: 0 5px; }
        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; }
        
        #prediction-layer { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); 
            pointer-events: none; z-index: 1; width: 80vw; display: flex; justify-content: center; align-items: center;
        }
        .prediction { display: none; max-width: 100%; max-height: 60vh; object-fit: contain; }
        .show-now { display: block !important; }
        
        /* æ ¸å¿ƒä¿®æ­£ï¼šè¦†è“‹å…¨è¢å¹•çš„é€æ˜å±¤ï¼Œç”¨æ–¼è§¸ç™¼æ¬Šé™ */
        #init-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; background: rgba(0,0,0,0); /* çµ•å°é€æ˜ä½†å¯é»æ“Š */
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="init-overlay"></div>
    <canvas id="canvas"></canvas>

    <div class="toolbar">
        <div class="color-btn" style="background:#000000" onclick="_0x4a2b('#000000',3)"></div>
        <div class="color-btn" style="background:#be0000" onclick="_0x4a2b('#be0000',3)"></div>
        <div class="color-btn" style="background:#2ed573" onclick="_0x4a2b('#2ed573',3)"></div>
        <div class="color-btn" style="background:#1e90ff" onclick="_0x4a2b('#1e90ff',3)"></div>
        <div class="color-btn" style="background:#ffa502" onclick="_0x4a2b('#ffa502',3)"></div>
        <div class="divider"></div>
        <button class="icon-btn" onclick="_0x4a2b('#ffffff',30)">ğŸ§¼</button>
        <button class="icon-btn" onclick="_0x1f3c()">ğŸ—‘ï¸</button>
    </div>

    <div id="prediction-layer">
        <img id="res-A" class="prediction" src="h3.png">
        <img id="res-B" class="prediction" src="d9.png">
        <img id="res-C" class="prediction" src="c6.png">
        <img id="res-D" class="prediction" src="s12.png">
    </div>

    <script>
        (function(){
            const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d'), overlay = document.getElementById('init-overlay');
            let drawing = false, lastX = 0, lastY = 0, shakeTriggered = false, shown = false, permissionGranted = false;

            // --- ä¿®æ­£ 2: ç²¾æº–åº§æ¨™æ¼”ç®—æ³• ---
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                // å„ªå…ˆä½¿ç”¨è§¸æ§é»åº§æ¨™ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨æ»‘é¼ åº§æ¨™
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                // è¨ˆç®—ç›¸å°æ–¼ç•«å¸ƒçš„æ¯”ä¾‹åº§æ¨™
                return {
                    x: (clientX - rect.left) * (canvas.width / rect.width),
                    y: (clientY - rect.top) * (canvas.height / rect.height)
                };
            }

            window._0x4a2b = (c, w) => { ctx.strokeStyle = c; ctx.lineWidth = w; };
            window._0x1f3c = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                document.querySelectorAll('.prediction').forEach(i => i.classList.remove('show-now'));
                shown = false; shakeTriggered = false;
            };

            // --- ä¿®æ­£ 3: iPhone 11 PWA æ¬Šé™è§¸ç™¼å™¨ ---
            async function requestMotionPermission() {
                if (permissionGranted) return;
                
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        // åœ¨ iOS PWA ä¸­ï¼Œé€™è¡Œå¿…é ˆç”± click äº‹ä»¶ç›´æ¥èª˜å°
                        const state = await DeviceOrientationEvent.requestPermission();
                        if (state === 'granted') {
                            window.addEventListener('deviceorientation', handleMotion, true);
                            permissionGranted = true;
                        }
                    } catch (e) { console.error(e); }
                } else {
                    window.addEventListener('deviceorientation', handleMotion, true);
                    permissionGranted = true;
                }
            }

            function handleMotion(e) {
                if (shown) return;
                let b = e.beta, g = e.gamma;
                if (Math.abs(b) > 155) shakeTriggered = true;
                if (shakeTriggered && Math.abs(b) < 60) {
                    shown = true; shakeTriggered = false;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let id = (g > 30) ? 'res-A' : (g < -30) ? 'res-B' : (b < -10) ? 'res-C' : 'res-D';
                    document.getElementById(id).classList.add('show-now');
                }
            }

            // åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š
            function init() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.lineJoin = 'round'; ctx.lineCap = 'round';
                _0x4a2b('#000000', 3);
            }

            // ç¬¬ä¸€æ¬¡é»æ“Šæ””æˆªï¼šåŒæ™‚è§£æ±ºæ¬Šé™èˆ‡å•Ÿå‹•ç•«ç­†
            overlay.addEventListener('touchstart', (e) => {
                requestMotionPermission(); // ç«‹å³è«‹æ±‚æ¬Šé™
                overlay.style.display = 'none'; // ç§»é™¤é®ç½©
                drawing = true;
                const p = getPos(e);
                [lastX, lastY] = [p.x, p.y];
            }, { passive: false });

            // ç¹ªåœ–é‚è¼¯
            canvas.addEventListener('touchstart', (e) => {
                drawing = true;
                const p = getPos(e);
                [lastX, lastY] = [p.x, p.y];
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                if (!drawing) return;
                e.preventDefault(); // ç¦æ­¢é é¢æ²å‹•
                const p = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
                [lastX, lastY] = [p.x, p.y];
            }, { passive: false });

            canvas.addEventListener('touchend', () => drawing = false);

            window.addEventListener('resize', init);
            init();
        })();
    </script>
</body>
</html>
