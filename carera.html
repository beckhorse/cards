<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Note</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
        
        /* 初始按鈕介面 */
        #setup-screen { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 100; background: #1a1a1a; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 10px; border: none; background: #444; color: white; }

        /* 偽裝黑屏介面 */
        #black-screen { position: fixed; inset: 0; background: #000; z-index: 50; display: none; }

        /* 繪圖介面 (偷看畫面隱藏在此) */
        #draw-screen { position: fixed; inset: 0; background: #fff; z-index: 10; display: none; }
        canvas { width: 100%; height: 100%; cursor: crosshair; }
        
        /* 關鍵：極小的偷看視窗 */
        #peek-video { 
            position: absolute; 
            top: 5px; 
            right: 5px; 
            width: 80px;  /* 設定很小，表演時只有你看得到 */
            height: auto; 
            opacity: 0.3; /* 半透明，降低觀眾察覺機會 */
            border: 1px solid #ddd;
            transform: scaleX(-1); /* 鏡像翻轉方便閱讀 */
            z-index: 60;
        }
        
        #status-indicator { position: fixed; bottom: 10px; left: 10px; font-size: 10px; color: #333; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <button onclick="initMagic()">啟動系統校準</button>
    </div>

    <div id="black-screen"></div>

    <div id="draw-screen">
        <video id="peek-video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="status-indicator">Ready</div>
    </div>

    <script>
        let mediaRecorder;
        let chunks = [];
        let isRecording = false;
        const peekVideo = document.getElementById('peek-video');
        const blackScreen = document.getElementById('black-screen');
        const drawScreen = document.getElementById('draw-screen');

        async function initMagic() {
            // 請求相機權限
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, // 使用後置鏡頭
                    audio: false 
                });
                peekVideo.srcObject = stream;
                
                // 處理 iOS 權限請求 (Motion & Orientation)
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }

                window.addEventListener('deviceorientation', handleMotion);
                document.getElementById('setup-screen').style.display = 'none';
                drawScreen.style.display = 'block'; // 先進到繪圖模式
                initCanvas();
            } catch (err) {
                alert("請允許相機與感應器權限才能表演！");
            }
        }

        function handleMotion(event) {
            let beta = event.beta; // 前後傾斜

            // 觸發條件：手機螢幕朝下 (Beta 接近 180 或 -180)
            if (Math.abs(beta) > 165) {
                if (!isRecording) startRecording();
                blackScreen.style.display = 'block';
            } else if (Math.abs(beta) < 30) { 
                // 手機拿起來 (角度回到水平)
                if (isRecording) stopRecording();
                blackScreen.style.display = 'none';
            }
        }

        function startRecording() {
            isRecording = true;
            chunks = [];
            const stream = peekVideo.srcObject;
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                peekVideo.srcObject = null;
                peekVideo.src = URL.createObjectURL(blob);
                peekVideo.loop = true;
                peekVideo.play();
            };
            
            mediaRecorder.start();
            document.getElementById('status-indicator').innerText = "REC...";
        }

        function stopRecording() {
            isRecording = false;
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
            document.getElementById('status-indicator').innerText = "VOD PLAYING";
        }

        // 簡單的繪圖功能實作
        function initCanvas() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            let drawing = false;
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            canvas.addEventListener('touchstart', (e) => {
                drawing = true;
                ctx.beginPath();
                ctx.moveTo(e.touches[0].clientX, e.touches[0].clientY);
            });
            canvas.addEventListener('touchmove', (e) => {
                if (!drawing) return;
                ctx.lineTo(e.touches[0].clientX, e.touches[0].clientY);
                ctx.stroke();
            });
            canvas.addEventListener('touchend', () => drawing = false);
        }
    </script>
</body>
</html>